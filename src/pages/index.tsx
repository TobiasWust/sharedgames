import Head from "next/head";
import { useEffect, useState } from "react";
import Game from "../components/Game";
import Player, { TPlayer } from "../components/Player";
import intersection from "../utils/intersection";

type PlayerWithGames = {
  player: TPlayer;
  ownedGames: string[];
};

export default function Home() {
  const [playerId, setPlayerId] = useState("tobiaswust");
  const [players, setPlayers] = useState<PlayerWithGames[]>([]);
  const [gameIds, setGameIds] = useState<string[]>([]);

  function getPlayerData(_playerID: string) {
    fetch(`/api/getPlayer?playerId=${_playerID}`)
      .then((res) => res.json())
      .then((data) => {
        if (
          players.find(
            (player) => player.player.personaname === data.player.personaname
          )
        ) {
          return;
        }
        setPlayers((state) => [...state, data]);
      });
  }

  function getFriends(_playerId: string) {
    fetch(`/api/getFriends?playerId=${_playerId}`)
      .then((res) => res.json())
      .then((data) => {
        data.forEach((steamId: string) => getPlayerData(steamId));
      });
  }

  function removePlayer(_playerId: string) {
    setPlayers((state) =>
      state.filter((player) => player.player.steamid !== _playerId)
    );
  }

  useEffect(() => {
    if (players.length > 1) {
      const gIds = intersection(players.map((player) => player.ownedGames));
      setGameIds(gIds);
    } else {
      setGameIds([]);
    }
  }, [players]);

  return (
    <>
      <Head>
        <title>Create Next App</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className="grid max-w-md gap-3">
        <input
          type="text"
          value={playerId}
          onChange={(e) => setPlayerId(e.target.value)}
        />
        <button type="button" onClick={() => getPlayerData(playerId)}>
          Get Player Data
        </button>
        <h2>Players:</h2>
        <ul>
          {players.map((player) => (
            <Player
              key={player.player.steamid}
              player={player.player}
              removePlayer={() => removePlayer(player.player.steamid)}
              getFriends={() => getFriends(player.player.steamid)}
            />
          ))}
        </ul>
        <h2>Games:</h2>
        <p>Games in common: {gameIds.length}</p>
        {gameIds.length === 0 && <p>No games in common</p>}
        <ul>
          {gameIds.map((gameId) => (
            <Game key={gameId} gameId={gameId} />
          ))}
        </ul>
      </main>
    </>
  );
}
